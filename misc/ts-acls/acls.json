// vim:ft=jsonc
{
	"groups": {
    // Control Groups
		"group:k8s": ["hayden@hayden.moe"],

    // Networks
		"group:net-phoebe": ["hayden@hayden.moe"],
		"group:net-tethys": ["hayden@hayden.moe"],

    // Clusters
		"group:k8s-phoebe": ["hayden@hayden.moe"],
	},

	"grants": [
    // give access to everything to admins
		{
			"src": ["autogroup:admin"],
			"dst": ["*"],
			"ip":  ["*"],
		},

		// give access to the entire network to net admins
		{
			"src": ["group:net-phoebe"],
			"dst": ["tag:net-phoebe"],
			"ip":  ["*"],
		},

    // give kubernetes api access to k8s admins
		{
			"src": ["group:k8s-phoebe", "group:k8s"],
			"dst": ["tag:k8s-phoebe"],
      "app": {
        "tailscale.com/cap/kubernetes": [{
          "impersonate": {
            "groups": ["system:masters"],
          },
        }],
      },
		},

    // enforce tsrecorder usage across all kubectl exec sessions
    {
      "src": ["*"],
      "dst": ["*"],
      "app": {
        "tailscale.com/cap/kubernetes": [{
          "recorder":        ["tag:tsrecorder"],
          "enforceRecorder": true,
        }],
      },
    },

		// give access to exit nodes to all users
		{
			"src": ["autogroup:member"],
			"dst": ["autogroup:internet"],
			"ip":  ["*"],
		},

		// give access to all the cloud services
		{
			"src": ["group:net-tethys"],
			"dst": ["tag:net-tethys"],
			"ip":  ["*"],
		},
	],

	"ssh": [
		{
			"action": "accept",
			"dst":    ["tag:net-phoebe"],
			"src":    ["group:net-phoebe"],
			"users":  ["root", "hayden"],
      "recorder": ["tag:tsrecorder"],
      "enforceRecorder": true,
		},
		{
			"action": "accept",
			"dst":    ["tag:net-tethys"],
			"src":    ["group:net-tethys"],
			"users":  ["root", "hayden", "rocky", "ubuntu"],
      "recorder": ["tag:tsrecorder"],
      "enforceRecorder": true,
		},
	],

	"tagowners": {
    // Networks
		"tag:net-phoebe": ["group:net-phoebe"],
		"tag:net-tethys": ["group:net-tethys"],

    // Applications
    "tag:tsrecorder": ["tag:k8s", "autogroup:admin"],

    // Clusters
		"tag:k8s":        ["group:k8s"],
		"tag:k8s-phoebe": ["tag:k8s", "group:k8s", "group:k8s-phoebe", "group:net-phoebe"],
	},
}
