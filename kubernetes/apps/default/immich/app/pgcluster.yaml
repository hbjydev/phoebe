---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: "immich-pg-barman"
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault
  target:
    name: "immich-pg-barman"
    template:
      data:
        ACCESS_KEY_ID: "{{ .access_key_id }}"
        SECRET_ACCESS_KEY: "{{ .secret_access_key }}"
  dataFrom:
    - extract:
        key: ucos/haydenmoe-volsync-postgres

---
apiVersion: barmancloud.cnpg.io/v1
kind: ObjectStore
metadata:
  name: immich-pg-barman-os
spec:
  configuration:
    destinationPath: s3://haydenmoe-volsync-postgres/immich-pg
    endpointURL: https://t9ag6.upcloudobjects.com
    s3Credentials:
      accessKeyId:
        name: "immich-pg-barman"
        key: ACCESS_KEY_ID
      secretAccessKey:
        name: "immich-pg-barman"
        key: SECRET_ACCESS_KEY
    wal:
      maxParallel: 1
      compression: bzip2
    data:
      compression: bzip2
  instanceSidecarConfiguration:
    env:
      - name: AWS_REQUEST_CHECKSUM_CALCULATION
        value: when_required
      - name: AWS_RESPONSE_CHECKSUM_VALIDATION
        value: when_required

---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: immich-pg
  annotations:
    cnpg.io/skipEmptyWalArchiveCheck: enabled
spec:
  # At the time of writing, immich is only compatible with pgvecto.rs <0.4. Latest postgres image with that version is 16.5.
  imageName: ghcr.io/tensorchord/cloudnative-pgvecto.rs:16.5-v0.3.0@sha256:be3f025d79aa1b747817f478e07e71be43236e14d00d8a9eb3914146245035ba
  instances: 1

  postgresql:
    enableAlterSystem: true
    shared_preload_libraries:
      - "vectors.so"

  monitoring:
    enablePodMonitor: true

  backup:
    retentionPolicy: ${PG_RETENTION_POLICY:-7d}

  storage:
    size: 4Gi
    storageClass: ceph-block

  plugins:
  - name: barman-cloud.cloudnative-pg.io
    isWALArchiver: true
    parameters:
      barmanObjectName: immich-pg-barman-os

---
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
  name: immich-pg-backup
spec:
  cluster:
    name: immich-pg
  schedule: '0 0 * * * *'
  backupOwnerReference: self
  method: plugin
  pluginConfiguration:
    name: barman-cloud.cloudnative-pg.io
