---
- name: Install dependencies
  ansible.builtin.package:
    name: bzip2
    state: present

- name: Download Restic
  ansible.builtin.get_url: 
    url: '{{ restic_download_url }}'
    dest: '/tmp/restic-{{ restic_version }}.bz2'
  register: download_restic

- name: Extract Restic
  ansible.builtin.shell:
    cmd: 'bzip2 -kdc /tmp/restic-{{ restic_version }}.bz2 > {{ restic_install_path }}'
    creates: '{{ restic_install_path }}'
  when: download_restic.changed

- name: Ensure Restic is executable and owned by root
  ansible.builtin.file:
    path: "{{ restic_install_path }}"
    mode: '0755'
    owner: root
    group: root

- name: Create Restic symlink
  ansible.builtin.file:
    src: "{{ restic_install_path }}"
    dest: "/usr/local/bin/restic"
    owner: root
    group: root
    state: link

- name: Set up restic files list
  ansible.builtin.copy:
    content: "{% for file in restic_files %}{{ file }}\n{% endfor %}"
    dest: /etc/restic/files
    owner: root
    group: root
    mode: "0644"

- name: Set up restic backup script
  ansible.builtin.template:
    src: usr/local/bin/restic-backup.j2
    dest: /usr/local/bin/restic-backup
    owner: root
    group: root
    mode: "0755"

- name: Set up restic environment file
  ansible.builtin.template:
    src: etc/restic/env.j2
    dest: /etc/restic/env
    owner: root
    group: root
    mode: "0600"

- name: Set up restic systemd unit
  ansible.builtin.template:
    src: etc/systemd/system/restic.service.j2
    dest: /etc/systemd/system/restic.service
    owner: root
    group: root
    mode: "0644"

- name: Set up restic systemd timer
  ansible.builtin.template:
    src: etc/systemd/system/restic.timer.j2
    dest: /etc/systemd/system/restic.timer
    owner: root
    group: root
    mode: "0644"

- name: Ensure timer is enabled
  ansible.builtin.systemd:
    enabled: true
    daemon_reload: true
    name: restic.timer
